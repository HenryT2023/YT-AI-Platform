# v0.1.0 数据库工程底座

## 文件树变更清单

### 新增文件

```
services/core-backend/
├── app/
│   ├── database/                          # 新增：数据库模块
│   │   ├── __init__.py                    # 模块导出
│   │   ├── engine.py                      # 异步引擎与会话管理
│   │   ├── base.py                        # 基础模型与混入类
│   │   ├── filters.py                     # 多租户查询过滤器
│   │   ├── health.py                      # 数据库健康检查
│   │   └── models/                        # 数据模型
│   │       ├── __init__.py
│   │       ├── tenant.py                  # 租户（全局表）
│   │       ├── site.py                    # 站点
│   │       ├── user.py                    # 用户（支持微信小程序）
│   │       ├── content.py                 # 内容（知识库等）
│   │       ├── npc_profile.py             # NPC 人设（版本化）
│   │       ├── quest.py                   # 研学任务
│   │       ├── evidence.py                # 证据
│   │       ├── conversation.py            # 会话与消息
│   │       ├── trace_ledger.py            # 证据链账本
│   │       └── user_feedback.py           # 用户反馈
│   └── api/
│       ├── deps.py                        # 新增：API 依赖注入
│       └── v1/
│           ├── health.py                  # 新增：健康检查 API
│           ├── contents.py                # 新增：内容管理 API
│           └── trace.py                   # 新增：证据链账本 API
├── alembic/
│   ├── env.py                             # 修改：使用新模型
│   └── versions/
│       └── 001_v0_1_0_initial_schema.py   # 新增：初始迁移
├── scripts/
│   └── seed_db.py                         # 新增：种子数据脚本
└── pyproject.toml                         # 修改：添加依赖

data/seeds/
└── v0.1.0.json                            # 新增：种子数据
```

### 修改文件

| 文件 | 变更说明 |
|------|----------|
| `pyproject.toml` | 添加 `sqlalchemy[asyncio]`, `greenlet`, `python-dotenv` |
| `alembic/env.py` | 使用新的 `app.database` 模块 |
| `app/api/__init__.py` | 注册新路由 |

---

## 数据模型概览

### 全局表（无 tenant_id/site_id）

| 表名 | 说明 | 原因 |
|------|------|------|
| `tenants` | 租户 | 自身就是租户 |

### 租户级表（有 tenant_id，无 site_id）

| 表名 | 说明 | 原因 |
|------|------|------|
| `sites` | 站点 | 自身就是站点 |
| `users` | 用户 | 用户可访问多个站点 |

### 业务表（有 tenant_id + site_id）

| 表名 | 说明 |
|------|------|
| `contents` | 内容（知识库、故事等） |
| `npc_profiles` | NPC 人设（版本化） |
| `quests` | 研学任务 |
| `quest_steps` | 任务步骤 |
| `evidences` | 证据 |
| `conversations` | 会话 |
| `messages` | 消息 |
| `trace_ledger` | 证据链账本 |
| `user_feedbacks` | 用户反馈 |

---

## 迁移与本地运行步骤

### 1. 环境准备

```bash
# 进入 core-backend 目录
cd services/core-backend

# 创建虚拟环境
python -m venv .venv
source .venv/bin/activate  # macOS/Linux

# 安装依赖
pip install -e ".[dev]"
```

### 2. 配置环境变量

```bash
# 复制环境变量模板
cp ../../.env.example .env

# 确保以下变量已配置
# POSTGRES_HOST=localhost
# POSTGRES_PORT=5432
# POSTGRES_USER=postgres
# POSTGRES_PASSWORD=postgres
# POSTGRES_DB=yantian
# DEFAULT_TENANT_ID=yantian
# DEFAULT_SITE_ID=yantian-main
```

### 3. 启动数据库

```bash
# 从项目根目录
cd ../..
make infra-up

# 或直接使用 docker-compose
docker-compose up -d postgres redis
```

### 4. 运行迁移

```bash
cd services/core-backend

# 升级到最新版本
alembic upgrade head

# 查看当前版本
alembic current

# 回滚一个版本
alembic downgrade -1
```

### 5. 导入种子数据

```bash
# 使用默认种子文件
python scripts/seed_db.py

# 指定种子文件
python scripts/seed_db.py --file seeds/v0.1.0.json

# 清空并重新导入
python scripts/seed_db.py --reset
```

### 6. 启动服务

```bash
# 开发模式
uvicorn app.main:app --reload --port 8000

# 或使用 Makefile
cd ../..
make run-backend
```

---

## 最小联调用例

### 1. 健康检查

```bash
# 基础健康检查
curl http://localhost:8000/api/health

# 响应示例
{
  "status": "healthy",
  "service": "core-backend",
  "version": "0.1.0",
  "database": {
    "healthy": true,
    "latency_ms": 2.5,
    "version": "PostgreSQL 15.x"
  }
}

# 就绪检查
curl http://localhost:8000/api/health/ready

# 存活检查
curl http://localhost:8000/api/health/live
```

### 2. 用户登录

```bash
curl -X POST http://localhost:8000/api/v1/auth/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin&password=admin123"

# 保存 token
TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

### 3. 创建内容

```bash
curl -X POST http://localhost:8000/api/v1/contents \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -H "X-Tenant-ID: yantian" \
  -H "X-Site-ID: yantian-main" \
  -d '{
    "content_type": "knowledge",
    "title": "严田村古井传说",
    "body": "村中心的古井相传有千年历史，井水清冽甘甜，四季不竭...",
    "tags": ["传说", "古井"],
    "domains": ["民间传说"],
    "credibility_score": 0.7
  }'
```

### 4. 查询内容列表

```bash
curl http://localhost:8000/api/v1/contents \
  -H "X-Tenant-ID: yantian" \
  -H "X-Site-ID: yantian-main"
```

### 5. 创建追踪记录

```bash
curl -X POST http://localhost:8000/api/v1/trace \
  -H "Content-Type: application/json" \
  -H "X-Tenant-ID: yantian" \
  -H "X-Site-ID: yantian-main" \
  -d '{
    "trace_id": "trace-001",
    "session_id": "session-001",
    "npc_id": "ancestor_yan",
    "request_type": "chat",
    "request_input": {"message": "请问严氏家训有哪些？"},
    "tool_calls": [{"name": "knowledge.search", "params": {"query": "严氏家训"}}],
    "evidence_ids": ["evidence-001"],
    "policy_mode": "normal",
    "started_at": "2024-12-13T12:00:00Z"
  }'
```

### 6. 查询追踪统计

```bash
curl "http://localhost:8000/api/v1/trace/stats/summary?days=7" \
  -H "X-Tenant-ID: yantian" \
  -H "X-Site-ID: yantian-main"
```

---

## 多租户规则示例

### 1. 使用 TenantBoundSession

```python
from app.api.deps import TenantSession

@router.get("/contents")
async def list_contents(ts: TenantSession):
    # 自动添加 tenant_id/site_id 过滤
    stmt = select(Content).where(Content.status == "published")
    result = await ts.execute(stmt)
    return result.scalars().all()

@router.post("/contents")
async def create_content(data: ContentCreate, ts: TenantSession):
    content = Content(**data.model_dump())
    # 自动设置 tenant_id/site_id
    ts.add(content)
    await ts.flush()
    return content
```

### 2. 使用 with_tenant_filter

```python
from app.database.filters import with_tenant_filter

stmt = select(Content).where(Content.status == "published")
stmt = with_tenant_filter(stmt, tenant_id="yantian", site_id="yantian-main")
result = await session.execute(stmt)
```

### 3. 请求头传递租户上下文

```bash
# 所有 API 请求都应带上租户头
curl http://localhost:8000/api/v1/contents \
  -H "X-Tenant-ID: yantian" \
  -H "X-Site-ID: yantian-main"
```

---

## 风险点与下一步

### 风险点

1. **迁移冲突**
   - 当前删除了旧的 `002_multi_tenant_and_mcp.py` 迁移
   - 如果已有数据库运行过旧迁移，需要手动清理或重建

2. **模型重复**
   - `app/domain/` 和 `app/database/models/` 可能存在重复模型
   - 建议统一使用 `app/database/models/`，逐步废弃 `app/domain/`

3. **全文搜索**
   - 当前使用 PostgreSQL `tsvector`，中文分词效果有限
   - 生产环境建议接入 Qdrant 向量检索

4. **密码安全**
   - 种子数据中的密码是明文，仅用于开发
   - 生产环境必须使用强密码

5. **会话管理**
   - 当前每个请求创建新会话，高并发下可能有性能问题
   - 建议添加连接池配置

### 下一步

1. **v0.1.1** - 清理旧模型，统一使用 `app/database/models/`
2. **v0.1.2** - 接入 Qdrant 向量检索
3. **v0.2.0** - 添加 Redis 缓存层
4. **v0.3.0** - Admin Console 集成
