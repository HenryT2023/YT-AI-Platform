# 系统架构

## 1. 架构概览

严田 AI 文明引擎采用 **模块化微服务架构**，核心设计目标：

- **可演化**：支持渐进式功能扩展
- **可替换**：AI 模型、数据库、第三方服务可独立替换
- **可复制**：多站点部署能力

## 2. 服务拓扑

```
                                    ┌─────────────────┐
                                    │   CDN / WAF     │
                                    └────────┬────────┘
                                             │
                    ┌────────────────────────┼────────────────────────┐
                    │                        │                        │
            ┌───────▼───────┐       ┌───────▼───────┐       ┌───────▼───────┐
            │   小程序/H5   │       │  Admin CMS    │       │   Kiosk       │
            │  (miniapp)    │       │(admin-console)│       │  (触屏大屏)   │
            └───────┬───────┘       └───────┬───────┘       └───────┬───────┘
                    │                       │                       │
                    └───────────────────────┼───────────────────────┘
                                            │
                                    ┌───────▼───────┐
                                    │  API Gateway  │  (Nginx / Kong)
                                    │   :80/:443    │
                                    └───────┬───────┘
                                            │
              ┌─────────────────────────────┼─────────────────────────────┐
              │                             │                             │
      ┌───────▼───────┐            ┌───────▼───────┐            ┌───────▼───────┐
      │ Core Backend  │            │AI Orchestrator│            │    Worker     │
      │    :8000      │◄──────────►│    :8001      │            │   (Celery)    │
      └───────┬───────┘            └───────┬───────┘            └───────┬───────┘
              │                            │                            │
              │         ┌──────────────────┼──────────────────┐         │
              │         │                  │                  │         │
      ┌───────▼───────┐ │         ┌───────▼───────┐          │ ┌───────▼───────┐
      │  PostgreSQL   │ │         │    Qdrant     │          │ │     Redis     │
      │   (主数据库)   │ │         │  (向量数据库)  │          │ │  (缓存/队列)  │
      └───────────────┘ │         └───────────────┘          │ └───────────────┘
                        │                                    │
                        │         ┌───────────────┐          │
                        │         │  Object Store │          │
                        └────────►│  (S3/OSS)     │◄─────────┘
                                  │  (媒体文件)    │
                                  └───────────────┘
```

## 3. 服务职责

### 3.1 Core Backend（核心后端）

**端口**: 8000

**职责**:

- 用户认证与授权（JWT + RBAC）
- 站点、场景、POI 管理
- NPC 配置管理
- 研学任务管理
- 游客档案管理
- 事件日志记录
- 内容 CRUD API

**不负责**:

- AI 推理（交给 AI Orchestrator）
- 异步任务执行（交给 Worker）

### 3.2 AI Orchestrator（AI 编排层）

**端口**: 8001

**职责**:

- NPC 对话编排
- 提示词模板管理
- RAG 检索增强生成
- 工具调用（Tool Calling）
- 文化准确性护栏
- 会话记忆管理
- 多模型抽象（OpenAI/Qwen/Llama）

**设计要点**:

- 与 Core Backend 分离，AI 迭代不影响业务系统
- 所有 LLM 调用通过统一抽象接口
- 护栏层确保文化准确性

### 3.3 Worker（异步任务）

**职责**:

- 文档向量化
- 媒体文件处理（转码、缩略图）
- 批量数据导入
- 定时任务（节气推送、数据清理）
- 报表生成

**技术**: Celery + Redis

### 3.4 Admin Console（运营后台）

**端口**: 3000

**职责**:

- 站点配置管理
- NPC 人设编辑
- 场景触发规则配置
- 研学任务设计
- 知识库管理
- 数据分析仪表盘
- 用户权限管理

**技术**: Next.js 14 + React + TailwindCSS

## 4. 数据流

### 4.1 游客对话流程

```
游客 → 小程序 → API Gateway → Core Backend (鉴权)
                                    │
                                    ▼
                            AI Orchestrator
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
                    ▼               ▼               ▼
              检索知识库      加载NPC人设      查询会话历史
              (Qdrant)      (Core API)       (Redis)
                    │               │               │
                    └───────────────┼───────────────┘
                                    │
                                    ▼
                            构建 Prompt
                                    │
                                    ▼
                            调用 LLM (OpenAI/Qwen)
                                    │
                                    ▼
                            护栏检查 (文化准确性)
                                    │
                                    ▼
                            返回响应 → 游客
```

### 4.2 内容管理流程

```
运营人员 → Admin Console → Core Backend API
                                │
                                ▼
                          PostgreSQL (存储)
                                │
                                ▼
                          Worker (异步处理)
                                │
                    ┌───────────┼───────────┐
                    │           │           │
                    ▼           ▼           ▼
              向量化入库    媒体处理    缓存更新
              (Qdrant)    (S3/OSS)    (Redis)
```

## 5. 多站点架构

### 5.1 数据隔离策略

所有核心实体都带 `site_id` 字段：

```python
class Site(Base):
    id: str           # 站点唯一标识，如 "yantian-main"
    name: str         # 站点名称
    config: dict      # 站点级配置

class Scene(Base):
    id: str
    site_id: str      # 关联站点
    name: str
    ...

class NPC(Base):
    id: str
    site_id: str      # 关联站点
    persona: dict
    ...
```

### 5.2 部署模式

**模式 A: 共享实例**

- 所有站点共享同一套服务实例
- 通过 `site_id` 进行数据隔离
- 适合：站点数量少、流量小

**模式 B: 独立实例**

- 每个站点独立部署一套服务
- 共享基础设施（数据库集群、向量库集群）
- 适合：站点流量大、需要物理隔离

## 6. 安全架构

### 6.1 认证与授权

- **游客端**: JWT Token（短期有效）
- **管理端**: JWT + RBAC（角色权限控制）
- **服务间**: Internal API Key

### 6.2 数据安全

- 敏感数据加密存储
- API 请求日志脱敏
- 定期安全审计

### 6.3 AI 安全

- 输入过滤（防注入）
- 输出护栏（文化准确性、禁用词）
- 调用频率限制

## 7. 可观测性

### 7.1 日志

- 结构化日志（JSON 格式）
- 统一 Request ID 追踪
- 日志级别：DEBUG / INFO / WARNING / ERROR

### 7.2 指标

- Prometheus 指标暴露
- 关键指标：QPS、延迟、错误率、AI 调用量

### 7.3 追踪

- OpenTelemetry 分布式追踪
- 关键链路：对话请求、内容检索、LLM 调用

## 8. 扩展点

### 8.1 Phase 2 服务

| 服务 | 职责 |
|------|------|
| IoT Gateway | MQTT 接入、设备管理、数据采集 |
| Farming Engine | 节气规则引擎、农耕任务生成 |
| Analytics | 游客画像、行为分析、报表 |

### 8.2 集成接口

| 接口 | 用途 |
|------|------|
| LLM Provider | 支持 OpenAI / Qwen / Ollama |
| TTS/ASR | 语音合成与识别 |
| Maps | 地图与定位服务 |
| Payment | 支付接口（微信/支付宝） |
