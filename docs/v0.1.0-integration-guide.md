# v0.1.0 多租户 + MCP 工具 + 证据链 集成指南

## 快速开始

### 1. 环境准备

```bash
# 复制环境变量
cp .env.example .env

# 确保以下变量已配置
# DEFAULT_TENANT_ID=yantian
# DEFAULT_SITE_ID=yantian-main
# INTERNAL_API_KEY=your-internal-api-key-change-in-production
```

### 2. 启动基础设施

```bash
# 启动 PostgreSQL, Redis, Qdrant
make infra-up

# 等待服务就绪
sleep 10
```

### 3. 数据库迁移

```bash
# 进入 core-backend 目录
cd services/core-backend

# 运行迁移
alembic upgrade head

# 返回根目录
cd ../..
```

### 4. 导入种子数据

```bash
# 导入租户、用户、站点、NPC、知识条目
python scripts/dev_seed_site.py
```

### 5. 启动服务

```bash
# 启动 core-backend (端口 8000)
make run-backend

# 新终端，启动 ai-orchestrator (端口 8001)
make run-orchestrator
```

---

## 最小联调用例

### 用例 1: 用户登录获取 Token

```bash
# 登录获取 access_token
curl -X POST http://localhost:8000/api/v1/auth/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin&password=admin123"

# 响应示例
# {
#   "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
#   "refresh_token": "...",
#   "token_type": "bearer"
# }
```

### 用例 2: 获取 MCP 工具列表

```bash
# 获取所有可用的 MCP 工具定义
curl http://localhost:8000/api/v1/mcp-tools/definitions

# 获取 OpenAI function calling 格式
curl http://localhost:8000/api/v1/mcp-tools/openai-format
```

### 用例 3: 执行 MCP 工具（知识检索）

```bash
# 使用内部 API Key 调用工具
curl -X POST http://localhost:8000/api/v1/mcp-tools/execute/internal \
  -H "Content-Type: application/json" \
  -H "X-Internal-API-Key: your-internal-api-key-change-in-production" \
  -H "X-Tenant-ID: yantian" \
  -H "X-Site-ID: yantian-main" \
  -H "X-Trace-ID: test-trace-001" \
  -d '{
    "tool_name": "knowledge.search",
    "params": {
      "query": "严氏家训",
      "domains": ["祖训家规"],
      "top_k": 3
    }
  }'

# 响应示例
# {
#   "success": true,
#   "tool_name": "knowledge.search",
#   "result": {
#     "results": [
#       {
#         "id": "uuid-xxx",
#         "title": "严氏家训十则",
#         "content": "一、敬祖宗...",
#         "score": 0.8,
#         "source": "《严氏族谱》",
#         "verified": true
#       }
#     ],
#     "total_count": 1
#   },
#   "trace_id": "test-trace-001",
#   "duration_ms": 45
# }
```

### 用例 4: 查看工具调用日志

```bash
# 需要登录后使用 Bearer Token
TOKEN="your-access-token"

curl http://localhost:8000/api/v1/mcp-tools/logs \
  -H "Authorization: Bearer $TOKEN" \
  -H "X-Tenant-ID: yantian" \
  -H "X-Site-ID: yantian-main"
```

### 用例 5: 创建知识条目

```bash
TOKEN="your-access-token"

curl -X POST http://localhost:8000/api/v1/knowledge \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -H "X-Tenant-ID: yantian" \
  -H "X-Site-ID: yantian-main" \
  -d '{
    "title": "严田村古井传说",
    "content": "村中心的古井相传有千年历史，井水清冽甘甜，四季不竭...",
    "knowledge_type": "local_custom",
    "domains": ["严氏家族历史", "民间传说"],
    "source": "村中老人口述",
    "credibility_score": 0.7
  }'
```

### 用例 6: 验证知识条目

```bash
TOKEN="your-access-token"
KNOWLEDGE_ID="uuid-of-knowledge-entry"

curl -X POST http://localhost:8000/api/v1/knowledge/$KNOWLEDGE_ID/verify \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -H "X-Tenant-ID: yantian" \
  -H "X-Site-ID: yantian-main" \
  -d '{
    "verified": true,
    "notes": "已与县志记载核对，内容属实"
  }'
```

### 用例 7: NPC 对话（带证据链）

```bash
# 调用 ai-orchestrator 的对话接口
curl -X POST http://localhost:8001/api/v1/chat \
  -H "Content-Type: application/json" \
  -H "X-Tenant-ID: yantian" \
  -H "X-Site-ID: yantian-main" \
  -d '{
    "npc_id": "uuid-of-ancestor-yan",
    "message": "请问严氏家训有哪些内容？",
    "session_id": "session-001",
    "use_mcp": true
  }'

# 响应示例（带证据链）
# {
#   "content": "后生问得好！吾严氏家训有云：一曰敬祖宗，祭祀不可废...",
#   "npc_id": "uuid-of-ancestor-yan",
#   "session_id": "session-001",
#   "trace_id": "abc123-def456",
#   "evidence_ids": ["uuid-of-knowledge-entry"],
#   "evidence_sufficient": true,
#   "confidence": 0.95,
#   "fallback_used": false
# }
```

---

## 新增数据模型

### Tenant（租户）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | String(50) | 租户 ID（主键） |
| name | String(100) | 租户名称 |
| plan | String(50) | 套餐：free/professional/enterprise |
| config | JSONB | 租户级配置 |
| status | String(20) | active/suspended |

### User（系统用户）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 用户 ID |
| tenant_id | String(50) | 所属租户（super_admin 可为空） |
| username | String(100) | 用户名（唯一） |
| role | String(50) | super_admin/tenant_admin/site_admin/operator/viewer |
| permissions | Array[String] | 额外权限列表 |
| allowed_site_ids | Array[String] | 可访问的站点列表 |

### KnowledgeEntry（知识条目）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 条目 ID |
| tenant_id | String(50) | 所属租户 |
| site_id | String(50) | 所属站点 |
| title | String(500) | 标题 |
| content | Text | 内容 |
| knowledge_type | String(50) | historical_fact/cultural_heritage/farming_wisdom/... |
| domains | Array[String] | 知识领域 |
| credibility_score | Float | 可信度 0-1 |
| verified | Boolean | 是否经过人工验证 |

### ToolCallLog（工具调用日志）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 日志 ID |
| trace_id | String(100) | 追踪 ID（关联同一请求链路） |
| tool_name | String(100) | 工具名称 |
| input_params | JSONB | 输入参数 |
| output_result | JSONB | 输出结果 |
| status | String(20) | pending/running/success/failed/timeout |
| duration_ms | Integer | 执行耗时 |

---

## 新增 API 端点

### 租户管理 `/api/v1/tenants`

- `GET /` - 列出租户（仅 super_admin）
- `GET /{tenant_id}` - 获取租户详情
- `POST /` - 创建租户
- `PATCH /{tenant_id}` - 更新租户
- `DELETE /{tenant_id}` - 删除租户（软删除）

### 用户管理 `/api/v1/users`

- `GET /` - 列出用户
- `GET /me` - 获取当前用户
- `GET /{user_id}` - 获取用户详情
- `POST /` - 创建用户
- `PATCH /{user_id}` - 更新用户
- `DELETE /{user_id}` - 删除用户

### 知识库 `/api/v1/knowledge`

- `GET /` - 列出知识条目
- `GET /search` - 搜索知识条目
- `GET /{knowledge_id}` - 获取条目详情
- `POST /` - 创建条目
- `PATCH /{knowledge_id}` - 更新条目
- `POST /{knowledge_id}/verify` - 验证条目
- `DELETE /{knowledge_id}` - 删除条目

### MCP 工具 `/api/v1/mcp-tools`

- `GET /definitions` - 获取工具定义列表
- `GET /definitions/{tool_name}` - 获取单个工具定义
- `GET /openai-format` - 获取 OpenAI function calling 格式
- `POST /execute` - 执行工具（需用户 Token）
- `POST /execute/internal` - 内部服务调用（需 X-Internal-API-Key）
- `GET /logs` - 获取调用日志
- `GET /logs/{log_id}` - 获取单条日志

---

## 风险点与建议

### 高优先级

1. **密钥管理**
   - `INTERNAL_API_KEY` 必须在生产环境更换
   - JWT 密钥需要使用强随机值
   - 建议使用 Vault 或 AWS Secrets Manager

2. **权限边界**
   - 当前 `check_permission` 是同步检查，需确保数据库查询已完成
   - 建议添加权限缓存（Redis）减少数据库压力

3. **证据链完整性**
   - 当前知识检索使用简单文本匹配，生产环境需接入 Qdrant 向量检索
   - 建议添加证据链签名防止篡改

### 中优先级

4. **性能优化**
   - MCP 工具调用日志量可能很大，建议添加分区表或归档策略
   - 知识条目全文搜索需要优化索引

5. **监控告警**
   - 添加 MCP 工具调用失败率监控
   - 添加证据链置信度低于阈值的告警

6. **数据一致性**
   - 多租户隔离需要在所有查询中强制添加 tenant_id 过滤
   - 建议使用 SQLAlchemy 事件监听器自动注入

### 低优先级

7. **API 版本管理**
   - 当前所有 API 在 `/v1/` 下，后续需要考虑版本升级策略

8. **国际化**
   - 保守回答模板目前硬编码中文，需要支持多语言

---

## 下一步计划

1. **v0.1.1** - 接入 Qdrant 向量检索，替换简单文本匹配
2. **v0.1.2** - 添加 LLM Tool Calling 支持，让 AI 自动选择工具
3. **v0.2.0** - 添加 Worker 异步任务，支持知识条目批量向量化
4. **v0.3.0** - Admin Console 集成，可视化管理租户、用户、知识库
