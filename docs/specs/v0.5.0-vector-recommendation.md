# v0.5.0 Spec: 向量化推荐与语义检索

## 1. Background / Context (背景与现状)

v0.4.0 实现了基于规则的推荐系统，通过标签匹配和简单规则生成推荐内容。
当前局限：

- 推荐逻辑依赖硬编码规则，扩展性差
- 无法理解用户意图的语义相似性
- NPC 知识检索仅支持关键词匹配，召回率低
- 农耕知识和文化内容未向量化，无法进行语义搜索

## 2. Goal & Non-Goal (目标与非目标)

### Goals

1. **构建向量知识库**：将农耕知识、NPC 人设、文化内容向量化存储
2. **实现语义检索**：基于向量相似度检索相关内容，提升 NPC 回答质量
3. **升级推荐算法**：结合向量相似度和规则引擎，实现混合推荐
4. **支持相似内容发现**：基于用户行为向量，推荐相似任务和内容

### Non-Goals

1. 不实现实时向量更新（批量离线更新即可）
2. 不引入复杂的推荐模型训练流程
3. 不处理多模态向量（图片、音频暂不支持）

## 3. Scope & Interfaces (范围与接口)

### 3.1 核心模块

#### A. 向量化服务 (Embedding Service)

负责将文本内容转换为向量表示。

```python
class EmbeddingService:
    async def embed_text(self, text: str) -> list[float]:
        """单条文本向量化"""
        
    async def embed_batch(self, texts: list[str]) -> list[list[float]]:
        """批量文本向量化"""
```

**支持的 Embedding 模型**：

- OpenAI text-embedding-3-small (1536 维)
- 阿里云 text-embedding-v2 (1536 维)
- 本地 bge-base-zh (768 维，可选）

#### B. 向量存储 (Vector Store)

使用 Qdrant 作为向量数据库。

**Collections 设计**：

| Collection | 内容 | 向量维度 | Payload |
|------------|------|----------|---------|
| knowledge | 农耕知识、文化内容 | 1536 | category, solar_term, tenant_id |
| npc_persona | NPC 人设片段 | 1536 | npc_id, domain |
| quest_content | 任务描述和步骤 | 1536 | quest_id, difficulty |
| user_behavior | 用户行为向量 | 1536 | visitor_id, action_type |

#### C. 语义检索 API

```text
GET /api/v1/search/semantic
  ?query=冬至有什么习俗
  &collection=knowledge
  &top_k=5
  &filter[solar_term]=dongzhi
```

**Response**:

```json
{
  "results": [
    {
      "id": "doc_001",
      "content": "冬至是二十四节气中最重要的节气之一...",
      "score": 0.92,
      "metadata": {
        "category": "custom",
        "solar_term": "dongzhi"
      }
    }
  ]
}
```

#### D. 混合推荐引擎

结合向量相似度和规则引擎：

```python
class HybridRecommender:
    async def recommend_quests(
        self,
        visitor_id: UUID,
        context: dict,
        strategy: str = "hybrid",  # "vector" | "rule" | "hybrid"
    ) -> list[QuestRecommendation]:
        """
        混合推荐策略：
        1. 向量召回：基于用户行为向量召回候选任务
        2. 规则过滤：应用业务规则（难度、前置条件）
        3. 重排序：综合评分排序
        """
```

### 3.2 数据流

```text
[用户查询] -> [Embedding] -> [向量检索] -> [规则过滤] -> [重排序] -> [返回结果]
                                |
                        [Qdrant Vector DB]
```

### 3.3 涉及仓库

| 仓库 | 改动范围 |
|------|----------|
| core-backend | 新增 EmbeddingService、VectorStore、SemanticSearch API |
| ai-orchestrator | 升级 KnowledgeRetriever 使用向量检索 |
| worker | 新增向量化批处理任务 |

## 4. Data & Dependencies (数据与依赖)

### 数据依赖

| 数据源 | 向量化内容 | 预估条数 |
|--------|------------|----------|
| FarmingKnowledge | title + content | ~100 |
| SolarTerm | description + farming_advice + poems | 24 |
| NPCProfile | persona JSON 片段 | ~50 |
| Quest | title + description + steps | ~50 |
| Content | 文化内容正文 | ~200 |

### 外部依赖

- **Qdrant**: 向量数据库 (Docker 部署)
- **OpenAI API**: text-embedding-3-small
- **Celery**: 异步向量化任务

### 新增基础设施

```yaml
# docker-compose.yml 新增
services:
  qdrant:
    image: qdrant/qdrant:v1.7.4
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
```

## 5. Constraints & Risks (约束与风险)

### 约束

1. **Embedding API 成本**：OpenAI embedding 按 token 计费，需控制调用频率
2. **向量维度一致性**：同一 Collection 内向量维度必须一致
3. **冷启动问题**：新用户无行为向量，需 fallback 到规则推荐

### 风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| Embedding API 不可用 | 检索降级 | 本地 fallback 模型 + 缓存 |
| 向量库数据不一致 | 检索结果错误 | 定期全量重建 + 增量同步 |
| 检索延迟过高 | 用户体验差 | 预热缓存 + 异步预取 |

## 6. Plan & Milestones (计划与里程碑)

### Phase 1: 基础设施 (1天)

- [ ] 部署 Qdrant 向量数据库
- [ ] 实现 EmbeddingService（支持 OpenAI）
- [ ] 实现 VectorStore 封装层
- [ ] 创建 Collections 和索引

### Phase 2: 数据向量化 (1天)

- [ ] 实现批量向量化脚本
- [ ] 向量化农耕知识和节气数据
- [ ] 向量化 NPC 人设
- [ ] 向量化任务内容

### Phase 3: 语义检索 API (1天)

- [ ] 实现 /api/v1/search/semantic 接口
- [ ] 集成到 AI Orchestrator 的 KnowledgeRetriever
- [ ] 添加检索结果缓存

### Phase 4: 混合推荐 (1天)

- [ ] 实现 HybridRecommender
- [ ] 升级 RecommendationService
- [ ] 用户行为向量化（可选）

## 7. Open Questions (开放问题)

| 问题 | 当前决策 | 备注 |
|------|----------|------|
| 使用哪个 Embedding 模型？ | OpenAI text-embedding-3-small | 成本低、效果好 |
| 向量更新策略？ | 批量离线更新 | 每日凌晨全量重建 |
| 是否需要用户行为向量？ | v0.5.0 可选 | 优先实现内容向量化 |

## 8. Success Metrics (成功指标)

| 指标 | 目标 | 测量方式 |
|------|------|----------|
| 语义检索召回率 | > 80% | 人工评测 Top-5 |
| 检索延迟 P99 | < 200ms | API 监控 |
| NPC 回答相关性 | 提升 20% | A/B 测试 |
