# v0.6.0 Spec: 多站点支持与运营管理

## 1. Background / Context (背景与现状)

当前系统已实现基础的多租户架构（tenant_id + site_id），但存在以下问题：

- 站点配置分散在代码和数据库中，缺乏统一管理界面
- 站点间数据隔离依赖开发者手动维护
- 无法动态创建新站点，需要手动初始化数据
- 缺少站点级别的运营数据统计

## 2. Goal & Non-Goal (目标与非目标)

### Goals

1. **站点配置中心**：统一管理站点基础信息、主题配置、功能开关
2. **站点数据隔离**：确保不同站点数据完全隔离，支持跨站点数据迁移
3. **站点初始化向导**：一键创建新站点，自动初始化基础数据
4. **运营数据看板**：站点级别的访问统计、任务完成率、NPC 对话量

### Non-Goals

1. 不实现站点间实时数据同步
2. 不支持站点合并或拆分
3. 不实现复杂的权限继承体系

## 3. Scope & Interfaces (范围与接口)

### 3.1 核心模块

#### A. 站点配置模型

```python
class SiteConfig(Base):
    __tablename__ = "site_configs"
    
    id: UUID
    tenant_id: str
    site_id: str
    
    # 基础信息
    name: str                    # 站点名称
    display_name: str            # 显示名称
    description: str             # 站点描述
    logo_url: str                # Logo URL
    
    # 主题配置
    theme: dict                  # 主题色、字体等
    
    # 功能开关
    features: dict               # {"quest_enabled": true, "iot_enabled": false}
    
    # 运营配置
    operating_hours: dict        # 运营时间
    contact_info: dict           # 联系方式
    
    # 状态
    status: str                  # active | maintenance | disabled
    created_at: datetime
    updated_at: datetime
```

#### B. 站点管理 API

```text
# 站点 CRUD
GET    /api/v1/sites                    # 列表
POST   /api/v1/sites                    # 创建
GET    /api/v1/sites/{site_id}          # 详情
PUT    /api/v1/sites/{site_id}          # 更新
DELETE /api/v1/sites/{site_id}          # 删除（软删除）

# 站点配置
GET    /api/v1/sites/{site_id}/config   # 获取配置
PUT    /api/v1/sites/{site_id}/config   # 更新配置

# 站点初始化
POST   /api/v1/sites/{site_id}/init     # 初始化基础数据

# 站点统计
GET    /api/v1/sites/{site_id}/stats    # 运营统计
```

#### C. 站点初始化服务

```python
class SiteInitializer:
    async def init_site(
        self,
        tenant_id: str,
        site_id: str,
        template: str = "default",  # "default" | "minimal" | "full"
    ) -> InitResult:
        """
        初始化站点基础数据：
        1. 创建默认 NPC（村长、导游）
        2. 创建示例任务
        3. 初始化成就体系
        4. 导入节气数据
        """
```

#### D. 运营统计服务

```python
class SiteStatsService:
    async def get_stats(
        self,
        tenant_id: str,
        site_id: str,
        period: str = "7d",  # "1d" | "7d" | "30d"
    ) -> SiteStats:
        """
        返回：
        - 访客数（UV/PV）
        - 任务完成数
        - NPC 对话数
        - 活跃用户数
        - 成就解锁数
        """
```

### 3.2 Admin Console 页面

| 页面 | 功能 |
|------|------|
| /admin/sites | 站点列表，支持搜索和筛选 |
| /admin/sites/new | 新建站点向导 |
| /admin/sites/[id] | 站点详情和配置 |
| /admin/sites/[id]/stats | 站点运营数据 |

### 3.3 数据隔离增强

```python
# 全局查询过滤器
class TenantSiteFilter:
    @staticmethod
    def apply(query, tenant_id: str, site_id: str):
        """自动为所有查询添加 tenant_id 和 site_id 过滤"""
        return query.filter(
            Model.tenant_id == tenant_id,
            Model.site_id == site_id,
        )
```

## 4. Data & Dependencies (数据与依赖)

### 数据模型变更

| 表 | 变更 |
|-----|------|
| site_configs | 新增表 |
| site_stats_daily | 新增表（每日统计快照） |
| 所有业务表 | 确保有 tenant_id + site_id 索引 |

### 初始化模板数据

```yaml
# templates/default.yaml
npcs:
  - id: npc_guide
    name: 导游小李
    role: 景区导游
    
quests:
  - id: quest_welcome
    name: 欢迎任务
    type: onboarding
    
achievements:
  - id: ach_first_visit
    name: 初来乍到
    rule_type: count
    rule_config:
      event: check_in
      threshold: 1
```

## 5. Constraints & Risks (约束与风险)

### 约束

1. **站点数量限制**：单租户最多 10 个站点（可配置）
2. **数据迁移复杂度**：跨站点数据迁移需要离线处理
3. **配置生效延迟**：部分配置需要重启服务生效

### 风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 站点配置不一致 | 功能异常 | 配置校验 + 默认值兜底 |
| 数据隔离泄露 | 安全问题 | 全局过滤器 + 审计日志 |
| 初始化失败 | 站点不可用 | 事务回滚 + 重试机制 |

## 6. Plan & Milestones (计划与里程碑)

### Phase 1: 数据模型 (0.5天)

- [ ] 创建 site_configs 表
- [ ] 创建 site_stats_daily 表
- [ ] 添加数据库迁移脚本

### Phase 2: 后端 API (1天)

- [ ] 实现站点 CRUD API
- [ ] 实现站点配置 API
- [ ] 实现 SiteInitializer
- [ ] 实现 SiteStatsService

### Phase 3: Admin Console (1天)

- [ ] 站点列表页面
- [ ] 新建站点向导
- [ ] 站点配置页面
- [ ] 运营数据看板

### Phase 4: 数据隔离增强 (0.5天)

- [ ] 全局查询过滤器
- [ ] 审计日志
- [ ] 数据迁移工具

## 7. Open Questions (开放问题)

| 问题 | 当前决策 | 备注 |
|------|----------|------|
| 站点配置是否支持继承？ | 否 | 每个站点独立配置 |
| 统计数据保留多久？ | 90 天 | 超过后归档 |
| 是否支持站点克隆？ | v0.6.0 不支持 | 后续版本考虑 |

## 8. Success Metrics (成功指标)

| 指标 | 目标 | 测量方式 |
|------|------|----------|
| 新站点创建时间 | < 5 分钟 | 从创建到可用 |
| 配置更新生效时间 | < 10 秒 | 热更新 |
| 数据隔离测试通过率 | 100% | 自动化测试 |
