# v0.3.0 IoT 集成与节气农耕引擎 Spec

## 1. Background / Context

### 1.1 现状
- v0.2.0 已完成研学系统（任务、游客画像、成就体系）
- 严田古村有丰富的农耕文化资源，需要与二十四节气智慧结合
- 现场有 IoT 设备（灯光、音效、传感器），需要统一管理

### 1.2 业务价值
- **节气农耕**：根据二十四节气推送农耕知识、任务和活动
- **IoT 控制**：统一管理现场设备，支持场景联动
- **智慧体验**：环境感知 + AI 推荐 = 个性化游览体验

## 2. Goal & Non-Goal

### 2.1 Goal
- 实现二十四节气数据模型和农耕知识库
- 设计 IoT 设备注册和状态管理
- 实现节气驱动的内容推送机制
- 提供设备控制 API（预留，不实现具体硬件对接）

### 2.2 Non-Goal
- 不实现具体硬件协议对接（MQTT/CoAP 等）
- 不实现实时视频流处理
- 不实现复杂的自动化规则引擎（v0.4.0 考虑）

## 3. Scope & Interfaces

### 3.1 数据模型

#### SolarTerm（节气）
```
solar_terms
├── id: UUID (PK)
├── code: string (唯一标识，如 "lichun", "yushui")
├── name: string (名称，如 "立春", "雨水")
├── order: int (顺序 1-24)
├── month: int (公历月份)
├── day_start: int (起始日，约数)
├── day_end: int (结束日，约数)
├── description: text (节气描述)
├── farming_advice: text (农耕建议)
├── cultural_customs: JSON (文化习俗)
├── poems: JSON (相关诗词)
├── created_at, updated_at
```

#### FarmingKnowledge（农耕知识）
```
farming_knowledge
├── id: UUID (PK)
├── tenant_id: string
├── site_id: string
├── solar_term_code: string (关联节气)
├── category: string (分类: crop/tool/technique/custom)
├── title: string (标题)
├── content: text (内容)
├── media_urls: JSON (图片/视频)
├── related_pois: JSON (关联兴趣点)
├── is_active: bool
├── sort_order: int
├── created_at, updated_at
```

#### IoTDevice（IoT 设备）
```
iot_devices
├── id: UUID (PK)
├── tenant_id: string
├── site_id: string
├── device_code: string (设备编码)
├── name: string (设备名称)
├── device_type: string (类型: light/speaker/sensor/camera/other)
├── location: string (位置描述)
├── scene_id: UUID (关联场景，可选)
├── poi_id: UUID (关联兴趣点，可选)
├── config: JSON (设备配置)
├── status: string (状态: online/offline/error)
├── last_heartbeat: datetime (最后心跳)
├── metadata: JSON (扩展数据)
├── is_active: bool
├── created_at, updated_at
```

#### IoTDeviceLog（设备日志）
```
iot_device_logs
├── id: UUID (PK)
├── tenant_id: string
├── site_id: string
├── device_id: UUID (FK -> iot_devices)
├── event_type: string (事件类型: status_change/command/error/heartbeat)
├── event_data: JSON (事件数据)
├── created_at
```

### 3.2 API 端点

#### 节气 API
| Method | Path | Description |
|--------|------|-------------|
| GET | /api/v1/solar-terms | 获取节气列表 |
| GET | /api/v1/solar-terms/current | 获取当前节气 |
| GET | /api/v1/solar-terms/{code} | 获取节气详情 |

#### 农耕知识 API
| Method | Path | Description |
|--------|------|-------------|
| GET | /api/v1/farming-knowledge | 获取农耕知识列表 |
| POST | /api/v1/farming-knowledge | 创建农耕知识 |
| GET | /api/v1/farming-knowledge/{id} | 获取知识详情 |
| PATCH | /api/v1/farming-knowledge/{id} | 更新知识 |
| DELETE | /api/v1/farming-knowledge/{id} | 删除知识 |
| GET | /api/v1/farming-knowledge/by-term/{code} | 按节气查询 |

#### IoT 设备 API
| Method | Path | Description |
|--------|------|-------------|
| GET | /api/v1/iot-devices | 获取设备列表 |
| POST | /api/v1/iot-devices | 注册设备 |
| GET | /api/v1/iot-devices/{id} | 获取设备详情 |
| PATCH | /api/v1/iot-devices/{id} | 更新设备 |
| DELETE | /api/v1/iot-devices/{id} | 删除设备 |
| POST | /api/v1/iot-devices/{id}/command | 发送控制命令 |
| POST | /api/v1/iot-devices/{id}/heartbeat | 设备心跳 |
| GET | /api/v1/iot-devices/{id}/logs | 获取设备日志 |

## 4. Data & Dependencies

### 4.1 二十四节气数据
预置 24 个节气的基础数据，包括：
- 节气名称、顺序、大致日期
- 节气描述和农耕建议
- 相关诗词和文化习俗

### 4.2 依赖关系
- 农耕知识关联节气和兴趣点
- IoT 设备关联场景和兴趣点
- 节气内容可触发任务推送

## 5. Constraints & Risks

### 5.1 约束
- 节气日期是约数，实际需要根据天文计算
- IoT 设备控制是预留接口，不实现具体协议
- 设备状态依赖心跳机制，可能有延迟

### 5.2 风险点
- **节气计算**：公历日期每年略有不同
  - 缓解：使用约数范围，或集成天文计算库
- **设备离线**：心跳超时判定需要合理阈值
  - 缓解：可配置超时时间，默认 5 分钟

## 6. Plan & Milestones

### Phase 1: 节气与农耕知识
- [ ] 创建 SolarTerm 和 FarmingKnowledge 数据模型
- [ ] 预置二十四节气基础数据
- [ ] 实现节气和农耕知识 API
- [ ] 前端管理页面

### Phase 2: IoT 设备管理
- [ ] 创建 IoTDevice 和 IoTDeviceLog 数据模型
- [ ] 实现设备注册、状态管理 API
- [ ] 实现设备控制命令接口（预留）
- [ ] 前端设备管理页面

### Phase 3: 联动与推送
- [ ] 节气变化时触发内容推送
- [ ] 设备状态变化通知
- [ ] 与游客画像联动（推荐节气相关内容）

## 7. Open Questions

1. **节气计算精度**：是否需要精确到小时？
   - 建议：v0.3.0 使用日期范围，后续可精确

2. **设备协议**：支持哪些 IoT 协议？
   - 建议：v0.3.0 只定义 HTTP API，具体协议 v0.4.0 实现

3. **离线设备处理**：离线设备是否自动禁用？
   - 建议：只标记状态，不自动禁用

---

## 附录：二十四节气列表

| 序号 | 代码 | 名称 | 月份 | 日期范围 |
|------|------|------|------|----------|
| 1 | lichun | 立春 | 2 | 3-5 |
| 2 | yushui | 雨水 | 2 | 18-20 |
| 3 | jingzhe | 惊蛰 | 3 | 5-7 |
| 4 | chunfen | 春分 | 3 | 20-22 |
| 5 | qingming | 清明 | 4 | 4-6 |
| 6 | guyu | 谷雨 | 4 | 19-21 |
| 7 | lixia | 立夏 | 5 | 5-7 |
| 8 | xiaoman | 小满 | 5 | 20-22 |
| 9 | mangzhong | 芒种 | 6 | 5-7 |
| 10 | xiazhi | 夏至 | 6 | 21-22 |
| 11 | xiaoshu | 小暑 | 7 | 6-8 |
| 12 | dashu | 大暑 | 7 | 22-24 |
| 13 | liqiu | 立秋 | 8 | 7-9 |
| 14 | chushu | 处暑 | 8 | 22-24 |
| 15 | bailu | 白露 | 9 | 7-9 |
| 16 | qiufen | 秋分 | 9 | 22-24 |
| 17 | hanlu | 寒露 | 10 | 8-9 |
| 18 | shuangjiang | 霜降 | 10 | 23-24 |
| 19 | lidong | 立冬 | 11 | 7-8 |
| 20 | xiaoxue | 小雪 | 11 | 22-23 |
| 21 | daxue | 大雪 | 12 | 6-8 |
| 22 | dongzhi | 冬至 | 12 | 21-23 |
| 23 | xiaohan | 小寒 | 1 | 5-7 |
| 24 | dahan | 大寒 | 1 | 20-21 |
