# v0.2.0 成就体系 (Achievements) Spec

## 1. Background / Context

### 1.1 现状
- 游客画像系统已完成，能够追踪用户的访问、对话、打卡、任务完成等行为数据
- 缺少激励机制来提升用户参与度和留存率
- 需要一个成就系统将「行为数据」转化为「可见的奖励反馈」

### 1.2 业务价值
- **提升参与度**：通过成就解锁激励用户探索更多内容
- **增加留存**：收集成就的目标感促使用户回访
- **数据洞察**：成就解锁数据可用于分析用户行为模式

## 2. Goal & Non-Goal

### 2.1 Goal
- 设计并实现一个可配置的成就系统
- 支持多种成就类型（计数型、事件型、组合型）
- 提供管理后台配置成就规则
- 实现自动触发和手动颁发两种模式
- 与游客画像系统联动，自动更新 `achievement_count`

### 2.2 Non-Goal
- 不实现复杂的成就树/前置依赖关系（v1.0 考虑）
- 不实现成就排行榜（v1.0 考虑）
- 不实现成就奖励兑换（积分商城等）

## 3. Scope & Interfaces

### 3.1 数据模型

#### Achievement（成就定义）
```
achievements
├── id: UUID (PK)
├── tenant_id: string (租户隔离)
├── site_id: string (站点隔离)
├── code: string (唯一标识，如 "first_conversation")
├── name: string (显示名称，如 "初次对话")
├── description: string (描述)
├── icon_url: string (图标 URL)
├── category: string (分类: exploration/social/learning/special)
├── tier: int (等级: 1=铜, 2=银, 3=金, 4=钻石)
├── points: int (积分值)
├── rule_type: string (规则类型: count/event/composite)
├── rule_config: JSON (规则配置)
├── is_hidden: bool (是否隐藏成就)
├── is_active: bool (是否启用)
├── sort_order: int (排序)
├── created_at, updated_at
```

#### UserAchievement（用户成就记录）
```
user_achievements
├── id: UUID (PK)
├── tenant_id: string
├── site_id: string
├── user_id: UUID (FK -> users)
├── achievement_id: UUID (FK -> achievements)
├── unlocked_at: datetime (解锁时间)
├── progress: int (当前进度，用于计数型)
├── progress_target: int (目标值)
├── source: string (来源: auto/manual)
├── source_ref: string (来源引用，如触发的事件 ID)
├── metadata: JSON (扩展数据)
├── created_at, updated_at
```

### 3.2 规则类型

#### 计数型 (count)
```json
{
  "type": "count",
  "metric": "conversation_count",  // 指标名
  "threshold": 10,                  // 阈值
  "operator": "gte"                 // 比较运算符: gte/gt/eq
}
```

#### 事件型 (event)
```json
{
  "type": "event",
  "event_name": "first_check_in",   // 事件名
  "conditions": {                    // 可选条件
    "scene_id": "specific-scene-id"
  }
}
```

#### 组合型 (composite)
```json
{
  "type": "composite",
  "operator": "and",                // and/or
  "rules": [
    { "type": "count", "metric": "conversation_count", "threshold": 5 },
    { "type": "count", "metric": "check_in_count", "threshold": 3 }
  ]
}
```

### 3.3 API 端点

#### 管理端 API
| Method | Path | Description |
|--------|------|-------------|
| GET | /api/v1/achievements | 获取成就列表 |
| POST | /api/v1/achievements | 创建成就 |
| GET | /api/v1/achievements/{id} | 获取成就详情 |
| PATCH | /api/v1/achievements/{id} | 更新成就 |
| DELETE | /api/v1/achievements/{id} | 删除成就 |
| POST | /api/v1/achievements/{id}/grant | 手动颁发成就给用户 |

#### 用户端 API
| Method | Path | Description |
|--------|------|-------------|
| GET | /api/v1/users/{user_id}/achievements | 获取用户已解锁成就 |
| GET | /api/v1/users/{user_id}/achievements/progress | 获取用户成就进度 |

## 4. Data & Dependencies

### 4.1 依赖的数据源
- `visitor_profiles`: 获取用户行为统计（conversation_count, check_in_count 等）
- `quest_submissions`: 任务完成事件
- `visitor_check_ins`: 打卡事件
- `conversations`: 对话事件

### 4.2 触发时机
成就检查在以下场景触发：
1. **API 调用时同步检查**：适用于关键事件（如首次对话）
2. **定时任务批量检查**：适用于计数型成就（每小时检查一次）
3. **手动颁发**：管理员通过后台颁发特殊成就

### 4.3 与游客画像联动
当用户解锁成就时：
- 更新 `visitor_profiles.achievement_count`
- 可选：自动添加成就相关的 `visitor_tags`

## 5. Constraints & Risks

### 5.1 约束
- 成就规则配置需要支持热更新（不重启服务）
- 同一成就同一用户只能解锁一次
- 需要支持多租户/多站点隔离

### 5.2 风险点
- **性能风险**：大量用户同时触发成就检查可能造成数据库压力
  - 缓解：使用缓存 + 批量处理
- **规则配置错误**：错误的规则可能导致成就无法解锁或错误解锁
  - 缓解：提供规则预览和测试功能

## 6. Plan & Milestones

### Phase 1: 数据模型与基础 API（当前）
- [ ] 创建 Achievement 和 UserAchievement 数据模型
- [ ] 实现成就 CRUD API
- [ ] 实现用户成就查询 API
- [ ] 数据库迁移

### Phase 2: 规则引擎
- [ ] 实现规则解析器（支持 count/event/composite）
- [ ] 实现成就检查服务 (AchievementService)
- [ ] 集成到关键事件触发点

### Phase 3: 前端管理
- [ ] 成就列表页面
- [ ] 成就创建/编辑表单
- [ ] 用户成就查看页面
- [ ] 手动颁发成就功能

### Phase 4: 优化与扩展
- [ ] 添加成就解锁通知机制
- [ ] 实现成就进度缓存
- [ ] 添加成就统计分析

## 7. Open Questions

1. **成就图标存储**：使用 URL 引用还是内置图标库？
   - 建议：先使用 URL，后续可扩展为图标库

2. **成就通知**：解锁成就时如何通知用户？
   - 建议：v0.2.0 先记录日志，v1.0 实现推送通知

3. **成就撤销**：是否支持撤销已颁发的成就？
   - 建议：支持，但需要记录撤销原因

---

## 附录：预设成就示例

| Code | Name | Category | Tier | Rule |
|------|------|----------|------|------|
| first_conversation | 初次对话 | social | 1 | event: first_conversation |
| social_butterfly_1 | 社交达人 I | social | 1 | count: conversation >= 10 |
| social_butterfly_2 | 社交达人 II | social | 2 | count: conversation >= 50 |
| explorer_1 | 探索者 I | exploration | 1 | count: check_in >= 5 |
| explorer_2 | 探索者 II | exploration | 2 | count: check_in >= 20 |
| quest_master_1 | 任务大师 I | learning | 1 | count: quest_completed >= 3 |
| quest_master_2 | 任务大师 II | learning | 2 | count: quest_completed >= 10 |
| loyal_visitor | 忠实访客 | special | 3 | count: visit >= 30 |
