# v0.4.0 Spec: AI 增强与个性化体验

## 1. Background / Context (背景与现状)

截至 v0.3.0，系统已具备完整的研学任务、游客画像、成就体系、节气农耕数据和 IoT 设备管理能力。
然而，这些模块目前相对孤立：

- NPC 对话缺乏对游客过往行为和当前环境的感知。
- 游客端展示是静态的，未根据画像或节气进行个性化适配。
- 大量高价值数据（如画像标签、节气建议）沉睡在数据库中，未转化为用户体验。

## 2. Goal & Non-Goal (目标与非目标)

### Goals

1. **构建全局上下文引擎 (Context Engine)**：实时聚合"人、时、地、物"数据，为 AI 提供感知能力。
2. **实现 Context-Aware NPC**：让 NPC 能够根据游客画像、当前节气和设备状态调整对话策略。
3. **打造个性化首页 (Smart Dashboard)**：基于规则+AI，动态展示推荐任务、节气知识和成就进度。

### Non-Goals

1. 不实现完全实时的流式推荐系统（基于规则+LLM即可）。
2. 不涉及复杂的设备联动控制（仅读取状态）。
3. 暂不引入新的大规模预训练模型，复用现有 LLM 能力。

## 3. Scope & Interfaces (范围与接口)

### 3.1 核心模块

#### A. 上下文构建器 (Core Backend)

负责聚合多源数据，生成标准化的 Context JSON。

**Input**: `visitor_id`, `current_location`, `timestamp`

**Output**:

```json
{
  "user": {
    "id": "uuid",
    "name": "游客A",
    "tags": ["亲子", "摄影爱好者"],
    "stats": {
      "quest_completed_count": 3,
      "check_in_count": 5,
      "npc_interaction_count": 12
    },
    "recent_quests": ["祠堂寻宝"],
    "unlocked_achievements": ["初来乍到", "祠堂探秘者"]
  },
  "environment": {
    "solar_term": {
      "code": "daxue",
      "name": "大雪",
      "farming_advice": "大雪时节，应做好防寒保暖工作...",
      "poem": "大雪江南见未曾，今年方始是严凝。"
    },
    "time_of_day": "afternoon",
    "iot_status": {
      "online_devices": 5,
      "alerts": []
    }
  },
  "recommendations": {
    "next_quest": {
      "id": "uuid",
      "title": "冬日农耕体验",
      "reason": "基于您的亲子标签推荐"
    },
    "topics": ["冬至习俗", "腌肉技艺", "节气养生"],
    "achievement_hint": {
      "name": "农耕达人",
      "progress": "2/3",
      "hint": "再完成1个农耕任务即可解锁"
    }
  }
}
```

#### B. 智能推荐 API (Core Backend)

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/v1/context/{visitor_id}` | GET | 获取游客完整上下文 |
| `/api/v1/recommendations/home` | GET | 首页聚合推荐数据 |
| `/api/v1/recommendations/quests` | GET | 推荐任务列表 |
| `/api/v1/recommendations/topics` | GET | 推荐对话话题 |

#### C. 动态 Prompt 引擎 (AI Orchestrator)

升级 `PromptBuilder`，支持 Jinja2 模板渲染，将 Context JSON 注入 System Prompt。

**示例 Prompt 模板**:

```jinja2
你是{{ npc.name }}，{{ npc.role }}。

## 当前环境感知
- 节气：{{ env.solar_term.name }}（{{ env.solar_term.farming_advice }}）
- 时段：{{ env.time_of_day }}

## 游客信息
- 称呼：{{ user.name or "游客" }}
- 兴趣标签：{{ user.tags | join("、") }}
- 已完成任务：{{ user.stats.quest_completed_count }}个
- 最近活动：{{ user.recent_quests | join("、") }}

## 对话策略
{% if user.stats.quest_completed_count == 0 %}
这是新游客，请热情欢迎并介绍基础任务。
{% elif "亲子" in user.tags %}
游客带着孩子，请用通俗易懂的语言，多讲故事。
{% endif %}

{% if env.solar_term.code == "dongzhi" %}
今天是冬至，可以主动提及冬至习俗和饺子文化。
{% endif %}
```

### 3.2 涉及仓库

| 仓库 | 改动范围 |
|------|----------|
| `core-backend` | 新增 `ContextService`、`RecommendationService`、API 端点 |
| `ai-orchestrator` | 升级 `PromptBuilder`，对接 Context API |
| `visitor-h5` | 首页重构，对话界面优化 |

## 4. Data & Dependencies (数据与依赖)

### 数据依赖

| 数据源 | 模型 | 版本 |
|--------|------|------|
| 游客画像 | `VisitorProfile`, `VisitorTag`, `VisitorCheckIn` | v0.2.0 |
| 成就数据 | `Achievement`, `UserAchievement` | v0.2.0 |
| 任务数据 | `Quest`, `QuestSubmission` | v0.2.0 |
| 节气数据 | `SolarTerm`, `FarmingKnowledge` | v0.3.0 |
| 设备状态 | `IoTDevice` | v0.3.0 |

### 外部依赖

- 现有的 LLM 服务（OpenAI/Qwen 等）
- Jinja2 模板引擎（Python 标准库）

## 5. Constraints & Risks (约束与风险)

### 约束

1. **Token 限制**：Context 数据需要剪枝，避免超出 LLM 上下文窗口。
2. **延迟要求**：Context 构建需在 100ms 内完成，不能阻塞对话响应。
3. **隐私保护**：游客数据仅用于当前会话，不跨租户共享。

### 风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| Context 数据过大 | Token 消耗高、响应慢 | 实现智能剪枝，只保留最相关数据 |
| 推荐逻辑复杂 | 开发周期长 | v0.4.0 使用规则引擎，v0.5.0 引入 ML |
| NPC 回复不自然 | 用户体验差 | 迭代优化 Prompt 模板 |

## 6. Plan & Milestones (计划与里程碑)

### Phase 1: 上下文与推荐后端 (Core Backend) - 2天

- [ ] 实现 `ContextService`：聚合 User + Environment 数据
- [ ] 实现 `RecommendationService`：基于规则的推荐逻辑
- [ ] 暴露 `/api/v1/context` 和 `/api/v1/recommendations` 接口
- [ ] 单元测试

### Phase 2: AI 编排升级 (AI Orchestrator) - 1天

- [ ] 升级 `PromptBuilder` 支持 Jinja2 模板
- [ ] 创建 Context-Aware NPC Prompt 模板
- [ ] 在 `chat` 接口中集成 Context 数据
- [ ] 集成测试

### Phase 3: 前端体验升级 (Visitor H5) - 2天

- [ ] 首页重构：增加"今日节气"、"猜你喜欢"板块
- [ ] 对话优化：增加"推荐话题"气泡
- [ ] 成就进度展示
- [ ] 端到端测试

## 7. Open Questions (开放问题)

| 问题 | 当前决策 | 备注 |
|------|----------|------|
| 推荐逻辑是否需要向量检索？ | v0.4.0 使用标签匹配 + 规则 | v0.5.0 可引入向量化推荐 |
| Context 缓存策略？ | 使用 Redis 缓存，TTL 5分钟 | 避免重复查询数据库 |
| 如何处理匿名游客？ | 使用 session_id 临时画像 | 不持久化，会话结束即清除 |

## 8. Success Metrics (成功指标)

| 指标 | 目标 | 测量方式 |
|------|------|----------|
| Context 构建延迟 | < 100ms | API 响应时间监控 |
| 推荐点击率 | > 20% | 埋点统计 |
| NPC 对话满意度 | > 4.0/5.0 | 用户反馈评分 |
