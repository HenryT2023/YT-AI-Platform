# v1.0.0 Spec: 生产就绪与运维体系

## 1. Background / Context (背景与现状)

经过 v0.1 ~ v0.6 的迭代，系统已具备完整的业务功能。但在生产环境部署前，需要解决以下问题：

- 缺乏完整的监控告警体系
- 性能优化不足，部分接口响应慢
- 安全加固不完善
- CI/CD 流程不完整
- 缺少运维文档和故障处理手册

## 2. Goal & Non-Goal (目标与非目标)

### Goals

1. **性能优化**：核心接口 P99 < 200ms，支持 1000 QPS
2. **监控告警**：全链路可观测，关键指标告警覆盖
3. **安全加固**：通过安全审计，满足等保要求
4. **CI/CD 完善**：自动化测试、构建、部署流水线
5. **运维文档**：完整的部署手册、故障处理手册

### Non-Goals

1. 不实现多云部署（单云即可）
2. 不实现蓝绿部署（灰度发布即可）
3. 不追求极致性能（满足业务需求即可）

## 3. Scope & Interfaces (范围与接口)

### 3.1 性能优化

#### A. 缓存策略

```python
# Redis 缓存层级
CACHE_LAYERS = {
    "L1": "本地内存缓存（TTL: 60s）",
    "L2": "Redis 缓存（TTL: 5min）",
    "L3": "数据库查询",
}

# 缓存 Key 设计
CACHE_KEYS = {
    "solar_term:current": "当前节气（TTL: 1h）",
    "npc:persona:{npc_id}": "NPC 人设（TTL: 10min）",
    "recommendations:home:{tenant}:{site}": "首页推荐（TTL: 5min）",
    "context:{visitor_id}": "游客上下文（TTL: 2min）",
}
```

#### B. 数据库优化

```sql
-- 关键索引
CREATE INDEX idx_quests_tenant_site_status ON quests(tenant_id, site_id, status);
CREATE INDEX idx_visitor_profiles_visitor ON visitor_profiles(tenant_id, site_id, visitor_id);
CREATE INDEX idx_solar_terms_month_day ON solar_terms(month, day_start, day_end);

-- 慢查询阈值
slow_query_threshold = 100ms
```

#### C. 接口性能目标

| 接口 | P50 | P99 | QPS |
|------|-----|-----|-----|
| GET /recommendations/home | 50ms | 150ms | 500 |
| POST /chat | 100ms | 300ms | 200 |
| GET /public/npcs | 20ms | 50ms | 1000 |
| GET /public/quests | 30ms | 80ms | 800 |

### 3.2 监控告警

#### A. 指标采集 (Prometheus)

```yaml
# 核心指标
metrics:
  - http_request_duration_seconds    # 请求延迟
  - http_requests_total              # 请求总数
  - http_request_errors_total        # 错误数
  - db_query_duration_seconds        # 数据库查询延迟
  - redis_operation_duration_seconds # Redis 操作延迟
  - llm_request_duration_seconds     # LLM 调用延迟
  - llm_token_usage_total            # Token 使用量
```

#### B. 日志规范 (Structured Logging)

```python
# 日志格式
{
    "timestamp": "2024-01-01T12:00:00Z",
    "level": "INFO",
    "service": "core-backend",
    "trace_id": "abc123",
    "span_id": "def456",
    "message": "Request completed",
    "duration_ms": 45,
    "status_code": 200,
    "path": "/api/v1/recommendations/home",
    "tenant_id": "yantian",
    "site_id": "main",
}
```

#### C. 告警规则

| 告警名称 | 条件 | 级别 | 通知方式 |
|----------|------|------|----------|
| API 高延迟 | P99 > 500ms 持续 5min | Warning | 企业微信 |
| API 错误率高 | 5xx > 1% 持续 3min | Critical | 电话 + 企业微信 |
| LLM 调用失败 | 失败率 > 5% | Critical | 企业微信 |
| 数据库连接池满 | 使用率 > 90% | Warning | 企业微信 |
| Redis 内存高 | 使用率 > 80% | Warning | 企业微信 |

#### D. 可观测性架构

```text
[应用] -> [OpenTelemetry Collector] -> [Jaeger (Traces)]
                                    -> [Prometheus (Metrics)]
                                    -> [Loki (Logs)]
                                    -> [Grafana (Dashboard)]
```

### 3.3 安全加固

#### A. 认证授权

```python
# JWT 配置
JWT_CONFIG = {
    "algorithm": "RS256",           # 非对称加密
    "access_token_expire": "15min", # 短期 Token
    "refresh_token_expire": "7d",   # 长期刷新 Token
    "issuer": "yantian-ai",
}

# API 限流
RATE_LIMITS = {
    "default": "100/minute",
    "chat": "20/minute",
    "auth": "10/minute",
}
```

#### B. 输入校验

```python
# 请求校验
class ChatRequest(BaseModel):
    message: str = Field(..., max_length=2000)
    npc_id: str = Field(..., regex=r"^npc_[a-z_]+$")
    
    @validator("message")
    def sanitize_message(cls, v):
        # XSS 过滤
        return bleach.clean(v)
```

#### C. 敏感数据处理

```python
# 日志脱敏
SENSITIVE_FIELDS = ["password", "token", "phone", "id_card"]

# 数据加密
ENCRYPTED_FIELDS = ["visitor_phone", "visitor_id_card"]
```

### 3.4 CI/CD 流水线

#### A. 流水线阶段

```yaml
# .github/workflows/ci.yml
stages:
  - lint:        # 代码检查
      - ruff (Python)
      - eslint (TypeScript)
      - markdownlint
      
  - test:        # 自动化测试
      - unit tests
      - integration tests
      - e2e tests (Playwright)
      
  - build:       # 构建镜像
      - Docker build
      - Push to registry
      
  - deploy:      # 部署
      - staging (自动)
      - production (手动审批)
```

#### B. 部署策略

```yaml
# 灰度发布
deployment:
  strategy: rolling
  maxSurge: 25%
  maxUnavailable: 0
  
# 健康检查
healthCheck:
  path: /api/health
  initialDelaySeconds: 10
  periodSeconds: 5
```

### 3.5 运维文档

| 文档 | 内容 |
|------|------|
| 部署手册 | 环境准备、部署步骤、配置说明 |
| 运维手册 | 日常巡检、扩缩容、备份恢复 |
| 故障手册 | 常见故障、排查步骤、恢复方案 |
| 安全手册 | 安全配置、漏洞处理、应急响应 |

## 4. Data & Dependencies (数据与依赖)

### 基础设施

| 组件 | 版本 | 用途 |
|------|------|------|
| PostgreSQL | 15+ | 主数据库 |
| Redis | 7+ | 缓存 + 会话 |
| Qdrant | 1.7+ | 向量数据库 |
| Prometheus | 2.45+ | 指标采集 |
| Grafana | 10+ | 监控面板 |
| Jaeger | 1.50+ | 链路追踪 |

### 云服务依赖

| 服务 | 提供商 | 用途 |
|------|--------|------|
| 对象存储 | 阿里云 OSS | 静态资源 |
| CDN | 阿里云 CDN | 加速分发 |
| 短信服务 | 阿里云 SMS | 验证码 |
| LLM API | OpenAI / 阿里云 | AI 对话 |

## 5. Constraints & Risks (约束与风险)

### 约束

1. **成本控制**：云服务月成本 < 5000 元
2. **合规要求**：满足等保二级
3. **SLA 目标**：可用性 > 99.9%

### 风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| LLM 服务不可用 | 核心功能降级 | 多供应商 fallback |
| 数据库故障 | 全站不可用 | 主从复制 + 自动切换 |
| 流量突增 | 服务过载 | 自动扩容 + 限流 |

## 6. Plan & Milestones (计划与里程碑)

### Phase 1: 性能优化 (2天)

- [ ] 实现多级缓存
- [ ] 添加数据库索引
- [ ] 优化慢查询
- [ ] 压测验证

### Phase 2: 监控告警 (2天)

- [ ] 部署 Prometheus + Grafana
- [ ] 配置核心指标采集
- [ ] 创建监控面板
- [ ] 配置告警规则

### Phase 3: 安全加固 (1天)

- [ ] 升级 JWT 配置
- [ ] 实现 API 限流
- [ ] 添加输入校验
- [ ] 日志脱敏

### Phase 4: CI/CD (1天)

- [ ] 完善 GitHub Actions
- [ ] 配置自动化测试
- [ ] 配置镜像构建
- [ ] 配置部署流程

### Phase 5: 文档与验收 (1天)

- [ ] 编写运维文档
- [ ] 安全审计
- [ ] 压力测试
- [ ] 上线 checklist

## 7. Open Questions (开放问题)

| 问题 | 当前决策 | 备注 |
|------|----------|------|
| 使用哪个云平台？ | 阿里云 | 成本和稳定性平衡 |
| 是否需要多可用区？ | 否 | v1.0 单可用区 |
| 日志保留多久？ | 30 天 | 超过后归档到 OSS |

## 8. Success Metrics (成功指标)

| 指标 | 目标 | 测量方式 |
|------|------|----------|
| 核心接口 P99 | < 200ms | Prometheus |
| 系统可用性 | > 99.9% | 监控告警 |
| 安全漏洞 | 0 高危 | 安全扫描 |
| 部署时间 | < 10min | CI/CD 日志 |
| 故障恢复时间 | < 30min | 运维记录 |

## 9. 上线 Checklist

### 上线前

- [ ] 所有自动化测试通过
- [ ] 压测达到性能目标
- [ ] 安全扫描无高危漏洞
- [ ] 监控告警配置完成
- [ ] 运维文档完成
- [ ] 回滚方案准备

### 上线中

- [ ] 灰度发布 10% 流量
- [ ] 观察 15 分钟无异常
- [ ] 逐步放量至 100%
- [ ] 确认核心指标正常

### 上线后

- [ ] 24 小时值班观察
- [ ] 收集用户反馈
- [ ] 记录上线问题
- [ ] 复盘总结
