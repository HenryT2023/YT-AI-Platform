# v0.2.3 Admin Console 去硬编码：统一注入 tenant/site + 后端强制过滤

## 验收一句话

改变 `DEFAULT_SITE_ID` 后，admin-console 只看到该 site 的任务提交数据；原 site 的数据不再混入。

---

## 文件变更清单

### 新增文件

| 文件 | 说明 |
|------|------|
| `services/core-backend/app/core/tenant_scope.py` | Tenant/Site Scope 依赖模块 |
| `scripts/site_scope_smoke.py` | 验收脚本 |

### 修改文件

| 文件 | 变更说明 |
|------|----------|
| `services/core-backend/app/api/v1/quest_submissions.py` | 使用 `RequiredScope` 替换 Query 参数 |
| `apps/admin-console/.env.local` | 添加 `DEFAULT_TENANT_ID` 和 `DEFAULT_SITE_ID` |
| `apps/admin-console/src/lib/auth-utils.ts` | 已有 tenant/site 工具函数（无需修改） |
| `apps/admin-console/src/app/admin/quests/submissions/page.tsx` | 移除硬编码的 `TENANT_ID`/`SITE_ID` |

---

## 核心实现

### 1. 后端 Scope 依赖 (`tenant_scope.py`)

```python
from fastapi import Header, HTTPException

async def get_tenant_site_scope(
    x_tenant_id: str | None = Header(alias="X-Tenant-ID"),
    x_site_id: str | None = Header(alias="X-Site-ID"),
) -> TenantSiteScope:
    if not x_tenant_id:
        raise HTTPException(status_code=400, detail="缺少必需的 Header: X-Tenant-ID")
    if not x_site_id:
        raise HTTPException(status_code=400, detail="缺少必需的 Header: X-Site-ID")
    return TenantSiteScope(tenant_id=x_tenant_id, site_id=x_site_id)

RequiredScope = Annotated[TenantSiteScope, Depends(get_tenant_site_scope)]
```

### 2. API 使用方式

```python
@router.get("", response_model=QuestSubmissionListResponse)
async def list_quest_submissions(
    current_user: ViewerOrAbove,
    scope: RequiredScope,  # 从 Header 注入
    db: Annotated[AsyncSession, Depends(get_db)],
):
    base_query = select(QuestSubmission).where(
        QuestSubmission.tenant_id == scope.tenant_id,
        QuestSubmission.site_id == scope.site_id,
    )
```

### 3. 前端代理自动注入 Header

`auth-utils.ts` 中的 `getAuthHeaders()` 已自动注入：

```typescript
export async function getAuthHeaders(): Promise<Record<string, string>> {
  const tenantId = await getTenantId();
  const siteId = await getSiteId();
  
  return {
    'Content-Type': 'application/json',
    'X-Tenant-ID': tenantId,
    'X-Site-ID': siteId,
    'Authorization': token ? `Bearer ${token}` : '',
  };
}
```

---

## 运行与验收步骤

### 1. 启动服务

```bash
# 基础设施
docker-compose up -d postgres redis

# 后端
cd services/core-backend
source .venv/bin/activate
uvicorn app.main:app --reload --port 8000

# 前端
cd apps/admin-console
npm run dev
```

### 2. 运行验收脚本

```bash
cd services/core-backend
source .venv/bin/activate
pip install httpx rich  # 如果没有安装
python ../../scripts/site_scope_smoke.py
```

### 3. 手动验证

```bash
# 测试缺少 Header 返回 400
curl -X GET "http://localhost:8000/api/v1/admin/quest-submissions" \
  -H "Authorization: Bearer <token>"
# 期望: {"detail":"缺少必需的 Header: X-Tenant-ID"}

# 测试带 Header 正常返回
curl -X GET "http://localhost:8000/api/v1/admin/quest-submissions" \
  -H "Authorization: Bearer <token>" \
  -H "X-Tenant-ID: yantian" \
  -H "X-Site-ID: yantian-main"
# 期望: {"items": [...], "total": N, ...}

# 测试不同 site 返回不同数据
curl -X GET "http://localhost:8000/api/v1/admin/quest-submissions" \
  -H "Authorization: Bearer <token>" \
  -H "X-Tenant-ID: yantian" \
  -H "X-Site-ID: yantian-test"
# 期望: {"items": [], "total": 0, ...}  (test site 没有数据)
```

### 4. 切换站点验证

修改 `apps/admin-console/.env.local`：

```bash
DEFAULT_SITE_ID=yantian-test
```

重启 admin-console，访问任务提交看板，应该看到空数据。

---

## 示例错误响应

### 缺少 X-Tenant-ID

```json
{
  "detail": "缺少必需的 Header: X-Tenant-ID"
}
```

### 缺少 X-Site-ID

```json
{
  "detail": "缺少必需的 Header: X-Site-ID"
}
```

---

## 验收标准

- [x] admin-console 的任务提交看板在不同 `DEFAULT_SITE_ID` 下显示不同数据
- [x] 后端 admin API 在缺失 header 时返回 400
- [x] 不出现跨站点数据混入

---

## 风险点与下一步

1. **其他管理 API 未覆盖**：本版本只改造了 `quest-submissions` 相关 API，其他如 `releases`、`alerts`、`feedback` 等需要后续版本跟进

2. **站点切换器 UI**：目前只能通过修改 `.env.local` 切换站点，后续可添加 UI 站点选择器

3. **RBAC 域隔离**：当前只做了数据过滤，未做角色权限与站点绑定，后续可扩展
